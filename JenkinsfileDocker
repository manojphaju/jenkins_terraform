pipeline {
    agent {
        docker {
            image 'hashicorp/terraform:1.6.7'
            args '-u root:root' // run as root for installing AWS CLI
        }
    }

    parameters {
        booleanParam(
            name: 'autoApprove',
            defaultValue: false,
            description: 'Automatically run apply after generating plan?'
        )
    }

    environment {
        AWS_ACCESS_KEY_ID     = credentials('AWS_ACCESS_KEY_ID')
        AWS_SECRET_ACCESS_KEY = credentials('AWS_SECRET_ACCESS_KEY')
        AWS_DEFAULT_REGION    = 'eu-west-2'
    }

    stages {

        stage('Install AWS CLI') {
            steps {
                sh '''
                    # Terraform image does not include AWS CLI by default
                    apk add --no-cache python3 py3-pip
                    pip3 install awscli
                    aws --version
                '''
            }
        }

        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/manojphaju/jenkins_terraform.git'
            }
        }

        stage('Verify AWS Connectivity') {
            steps {
                sh 'aws sts get-caller-identity'
            }
        }

        stage('Terraform Init') {
            steps {
                sh 'terraform init'
            }
        }

        stage('Terraform Plan') {
            steps {
                sh '''
                    terraform plan -out=tfplan -input=false
                    terraform show -no-color tfplan > tfplan.txt
                '''
            }
        }

        stage('Approval') {
            when {
                not {
                    equals expected: true, actual: params.autoApprove
                }
            }
            steps {
                input message: "Terraform plan generated. Do you want to apply?",
                      parameters: [
                          booleanParam(
                              name: 'Proceed',
                              defaultValue: true,
                              description: 'Approve Terraform apply?'
                          )
                      ]
            }
        }

        stage('Terraform Apply') {
            steps {
                script {
                    def applyCmd = "terraform apply -input=false tfplan"
                    if (params.autoApprove) {
                        applyCmd += " -auto-approve"
                    }
                    sh applyCmd
                }
            }
        }

        stage('Terraform Destroy') {
            steps {
                input message: "Do you want to destroy all Terraform-managed resources?",
                      parameters: [
                          booleanParam(
                              name: 'ProceedDestroy',
                              defaultValue: false,
                              description: 'Approve Terraform destroy?'
                          )
                      ]
                sh 'terraform destroy -auto-approve'
            }
        }
    }

    post {
        always {
            archiveArtifacts artifacts: 'tfplan.txt', fingerprint: true
        }
    }
}
